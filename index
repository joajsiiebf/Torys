<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Foro Torys Premium</title>
  <style>
    /* ‚Äî Estilos generales y temas ‚Äî */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { width:100%; height:100%; font-family: 'Arial', sans-serif; display:flex; justify-content:center; padding-top:20px; overflow-x:hidden; }
    body.dark { background: #000; color: #FFD700; }
    body.light { background: #fff; color: #000; }
    body.dark .toryCard { background: rgba(0,0,0,0.05); color: #fff; border: 1px solid rgba(255,215,0,0.2); }
    body.light .toryCard { background: rgba(255,255,255,0.05); color: #000; border: 1px solid rgba(255,215,0,0.3); }
    body::before {
      content: ''; position:fixed; top:0; left:0; width:100%; height:100%;
      background: radial-gradient(circle at center, #FFD700 0%, #000 80%); z-index:-2;
    }
    .particles { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; pointer-events:none; }
    .container { width:90%; max-width:900px; display:flex; flex-direction:column; gap:20px; }
    header { text-align:center; margin-bottom:10px; }
    header h1 { color:#FFD700; font-size:2rem; text-shadow:0 0 15px #FFD700, 0 0 25px #FFD700; }
    header p { color:#FFD700; font-size:1rem; opacity:0.8; }
    #onlineCount { color:#FFD700; font-weight:bold; text-align:center; margin-bottom:10px; }

    /* Nickname bubble + modal */
    #nicknameBubble {
      position:fixed; bottom:20px; left:20px;
      background:#FFD700; color:#000;
      padding:10px 15px; border-radius:20px;
      cursor:pointer; font-weight:bold;
      box-shadow:0 0 15px #FFD700; transition:0.2s; z-index:10;
    }
    #nicknameBubble:hover { box-shadow:0 0 25px #FFD700; }
    #nicknameModal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center;
      z-index:20; display:none;
    }
    #nicknameModalContent {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(15px) saturate(200%);
      border:1px solid rgba(255,215,0,0.2); border-radius:15px;
      padding:20px; display:flex; flex-direction:column; gap:10px;
    }
    #nicknameModalContent input, #nicknameModalContent button {
      padding:10px; border-radius:6px; border:none; font-size:1rem;
    }
    #nicknameModalContent button {
      background: linear-gradient(90deg, #FFD000, #FFA500);
      color:#000; font-weight:bold; cursor:pointer; transition:0.2s;
    }
    #nicknameModalContent button:hover { box-shadow:0 0 20px #FFD700; }

    /* Formulario y feed */
    #toryForm {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(15px) saturate(200%);
      border:1px solid rgba(255,215,0,0.2); border-radius:20px;
      box-shadow: inset 0 0 15px rgba(255,215,0,0.3), 0 0 25px rgba(255,215,0,0.4);
      padding:15px; display:flex; flex-direction:column;
    }
    #toryForm input[type=text] {
      padding:10px; border-radius:6px; border:none; margin-bottom:10px; font-size:1rem;
    }
    #toryForm button {
      padding:10px; border:none; border-radius:6px;
      background: linear-gradient(90deg, #FFD000, #FFA500);
      color:#000; font-weight:bold; cursor:pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #toryForm button:hover {
      transform:scale(1.05);
      box-shadow:0 0 20px #FFD700;
    }

    #toryFeedContainer { display:flex; flex-direction:column; }
    #toryFeedTitle {
      color:#FFD700; font-size:1.5rem; font-weight:bold; margin-bottom:10px;
      text-shadow:0 0 15px #FFD700;
    }
    #toryFeed {
      display:flex; flex-direction:column; gap:15px;
      max-height:70vh; overflow-y:auto;
      scrollbar-width:thin; scrollbar-color:#FFD700 rgba(255,255,255,0.1);
    }
    #toryFeed::-webkit-scrollbar { width:8px; }
    #toryFeed::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius:4px; }
    #toryFeed::-webkit-scrollbar-thumb { background: #FFD700; border-radius:4px; }

    .toryCard {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(15px) saturate(200%);
      border:1px solid rgba(255,215,0,0.2);
      border-radius:15px; padding:15px;
      box-shadow:0 0 15px #FFD700, inset 0 0 10px #FFD700;
      animation: fadeIn 0.5s ease;
      transition: transform 0.2s, box-shadow 0.2s;
      color: inherit;
      position:relative;
    }
    .toryCard:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 30px #FFD700, inset 0 0 15px #FFD700;
    }
    .toryCard .timestamp {
      color:#FFD700; font-size:0.75rem; opacity:0.7; margin-bottom:5px;
    }

    .toryActions { display:flex; justify-content:flex-start; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .toryActions button {
      padding:5px 10px; border:none; border-radius:6px;
      background: rgba(255,215,0,0.2); color:#FFD700;
      cursor:pointer; font-weight:bold; transition:0.2s, box-shadow 0.2s;
    }
    .toryActions button:hover {
      background: rgba(255,215,0,0.4);
      box-shadow:0 0 15px #FFD700;
    }

    .nicknameBubbleCard {
      position:absolute; top:10px; right:10px;
      background:#FFD700; color:#000;
      padding:3px 8px; border-radius:12px;
      font-size:0.75rem; font-weight:bold; opacity:0.9;
    }

    #scrollTopBtn {
      position:fixed; bottom:20px; right:20px;
      padding:10px; border:none; border-radius:50%;
      background: linear-gradient(90deg,#FFD000,#FFA500);
      color:#000; font-weight:bold; cursor:pointer;
      box-shadow:0 0 15px #FFD700; z-index:10;
    }
    #scrollTopBtn:hover {
      box-shadow:0 0 25px #FFD700;
    }

    #themeToggle {
      position:fixed; bottom:20px; right:80px;
      padding:10px 15px; border:none; border-radius:20px;
      background:#FFD700; color:#000; font-weight:bold;
      cursor:pointer; box-shadow:0 0 15px #FFD700; z-index:10;
    }
    #themeToggle:hover { box-shadow:0 0 25px #FFD700; }

    #chatContainer {
      position:fixed; bottom:80px; right:20px;
      width:300px; max-height:400px;
      background:rgba(0,0,0,0.8); color:#fff; border-radius:15px;
      padding:10px; display:flex; flex-direction:column; gap:5px;
      overflow-y:auto; z-index:10;
    }
    #chatMessages { flex:1; overflow-y:auto; }
    #chatInput { padding:5px; border:none; border-radius:6px; outline:none; width:100%; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    @media(max-width:768px){ .container{ width:95%; } #chatContainer { width:200px; } }
  </style>
</head>
<body class="dark">
  <canvas class="particles"></canvas>
  <div class="container">
    <header>
      <h1>üí¨ Foro de Torys</h1>
      <p>Comparte, comenta y vota tus Torys favoritos</p>
    </header>

    <div id="onlineCount">Personas en l√≠nea: 0</div>

    <div id="nicknameBubble">Elige tu Nickname</div>
    <div id="nicknameModal">
      <div id="nicknameModalContent">
        <input id="nicknameInput" type="text" placeholder="Tu nickname an√≥nimo" maxlength="15" autocomplete="off"/>
        <button id="setNicknameBtn">Guardar Nickname</button>
      </div>
    </div>

    <form id="toryForm">
      <input id="toryInput" type="text" placeholder="Escribe tu Tory..." autocomplete="off"/>
      <button type="submit">Publicar Tory</button>
    </form>

    <div id="toryFeedContainer">
      <div id="toryFeedTitle">Torys Recientes</div>
      <div id="toryFeed">
        <div class="placeholder">No hay Torys a√∫n, s√© el primero en publicar üí¨</div>
      </div>
    </div>

  </div>

  <button id="scrollTopBtn">‚Üë</button>
  <button id="themeToggle">üåì Tema</button>

  <div id="chatContainer">
    <div id="chatMessages"></div>
    <input id="chatInput" type="text" placeholder="Escribe mensaje..."/>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
  <script>
    // ‚Äî Config Firebase ‚Äî
    const firebaseConfig = {
      apiKey: "AIzaSyDYPKKEtJmqazv6MhuRhfS79jyHf2NpqoA",
      authDomain: "torys-16335.firebaseapp.com",
      databaseURL: "https://torys-16335-default-rtdb.firebaseio.com",
      projectId: "torys-16335",
      storageBucket: "torys-16335.firebasestorage.app",
      messagingSenderId: "97006009990",
      appId: "1:97006009990:web:f815478cf0d219f8d15b07",
      measurementId: "G-H9D9DEKZ7K"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM elements
    const toryFeed = document.getElementById('toryFeed');
    const toryForm = document.getElementById('toryForm');
    const toryInput = document.getElementById('toryInput');
    const onlineCount = document.getElementById('onlineCount');
    const nicknameBubble = document.getElementById('nicknameBubble');
    const nicknameModal = document.getElementById('nicknameModal');
    const nicknameInput = document.getElementById('nicknameInput');
    const themeToggle = document.getElementById('themeToggle');
    const chatContainer = document.getElementById('chatContainer');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');

    // Part√≠culas de fondo
    const canvas = document.querySelector('.particles');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    for(let i=0; i<200; i++){
      particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, radius: Math.random()*3+1.5, speed: Math.random()*1+0.5 });
    }
    function animateParticles(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255,215,0,0.7)';
        ctx.fill();
        p.y -= p.speed;
        if(p.y < 0) p.y = canvas.height;
      });
      requestAnimationFrame(animateParticles);
    }
    animateParticles();

    // Nickname
    let nickname = localStorage.getItem('toryNickname') || '';
    nicknameInput.value = nickname;
    if(!nickname) nicknameBubble.style.display = 'block';
    else nicknameBubble.style.display = 'none';

    nicknameBubble.addEventListener('click', ()=>{
      nicknameModal.style.display = 'flex';
    });
    document.getElementById('setNicknameBtn').addEventListener('click', ()=>{
      nickname = nicknameInput.value.trim() || 'An√≥nimo';
      localStorage.setItem('toryNickname', nickname);
      nicknameModal.style.display = 'none';
      nicknameBubble.style.display = 'none';
    });

    // Tema
    themeToggle.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
      const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('toryTheme', theme);
    });
    const savedTheme = localStorage.getItem('toryTheme');
    if(savedTheme){
      document.body.className = savedTheme;
    } else {
      document.body.className = 'dark';
    }

    // Usuarios online (presencia)
    const presenceRef = db.ref('presence');
    const myRef = presenceRef.push();
    myRef.onDisconnect().remove();
    myRef.set(true);
    presenceRef.on('value', snap => {
      onlineCount.textContent = `Personas en l√≠nea: ${snap.numChildren()}`;
    });

    // Publicar Tory
    toryForm.addEventListener('submit', e=>{
      e.preventDefault();
      const text = toryInput.value.trim();
      if(!text) return;
      const data = {
        text,
        timestamp: Date.now(),
        nickname: nickname || 'An√≥nimo',
        'üëç': 0,
        'üëé': 0,
        'üòÇ': 0,
        'üò°': 0
      };
      db.ref('torys').push(data);
      toryInput.value = '';
    });

    // Render Tory
    function renderTory(key, data){
      if(document.querySelector('.placeholder')) document.querySelector('.placeholder').remove();
      const card = document.createElement('div');
      card.className = 'toryCard';
      card.dataset.id = key;
      card.dataset['üëç'] = data['üëç'] || 0;
      card.dataset['üòÇ'] = data['üòÇ'] || 0;
      card.dataset['üò°'] = data['üò°'] || 0;

      const date = new Date(data.timestamp || Date.now()).toLocaleString();
      card.innerHTML = `<div class="timestamp">${date}</div><div>${data.text}</div>`;
      const nb = document.createElement('div');
      nb.className = 'nicknameBubbleCard';
      nb.textContent = data.nickname || 'An√≥nimo';
      card.appendChild(nb);

      const actions = document.createElement('div');
      actions.className = 'toryActions';
      ['üëç','üëé','üòÇ','üò°'].forEach(emoji=>{
        const btn = document.createElement('button');
        btn.textContent = `${emoji} ${data[emoji] || 0}`;
        btn.addEventListener('click', ()=>{
          db.ref('torys/'+key+'/'+emoji).transaction(c => (c||0)+1);
        });
        actions.appendChild(btn);
      });
      card.appendChild(actions);

      toryFeed.prepend(card);
    }

    db.ref('torys').on('child_added', snap => { renderTory(snap.key, snap.val()); });
    db.ref('torys').on('child_changed', snap => {
      const card = document.querySelector(`.toryCard[data-id='${snap.key}']`);
      if(card){
        ['üëç','üëé','üòÇ','üò°'].forEach(emoji=>{
          const btn = card.querySelector('.toryActions button:nth-child(' + (['üëç','üëé','üòÇ','üò°'].indexOf(emoji)+1) + ')');
          if(btn) btn.textContent = emoji + ' ' + (snap.val()[emoji] || 0);
          card.dataset[emoji] = snap.val()[emoji] || 0;
        });
      }
    });

    // Chat global
    chatInput.addEventListener('keyup', e=>{
      if(e.key === 'Enter'){
        const msg = chatInput.value.trim();
        if(!msg) return;
        db.ref('chat').push({ text: msg, nickname: nickname || 'An√≥nimo', timestamp: Date.now() });
        chatInput.value = '';
      }
    });
    db.ref('chat').on('child_added', snap => {
      const m = snap.val();
      const div = document.createElement('div');
      const time = new Date(m.timestamp || Date.now()).toLocaleTimeString();
      div.textContent = `[${time}] ${m.nickname}: ${m.text}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // Scroll top button
    document.getElementById('scrollTopBtn').addEventListener('click', ()=>{
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

  </script>
</body>
</html>
